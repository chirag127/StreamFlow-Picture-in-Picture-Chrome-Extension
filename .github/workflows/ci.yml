name: CI/CD Pipeline

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build_test_lint_security:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20' # Use Node.js 20, the current LTS recommended for 2025/2026
        cache: 'npm' # Cache npm dependencies for faster builds

    - name: Install dependencies
      # Use 'npm ci' for clean and reproducible builds in CI environments
      run: npm ci

    - name: Run Linting with Biome
      # Enforce code quality and best practices as per AGENTS.md (Biome for web/app stack)
      # Assumes 'npm run lint' is configured to execute 'biome check .'
      run: npm run lint

    - name: Check Code Formatting with Biome
      # Ensure consistent code style. Assumes 'npm run format:check' or 'npm run format -- --check'
      # for non-modifying format checks.
      run: npm run format -- --check || npm run format:check # Prioritize existing script, fallback to general check

    - name: Run Unit and Integration Tests with Vitest
      # Execute tests and generate coverage reports. Assumes 'npm test' runs 'vitest run --coverage'
      run: npm test

    - name: Build Chrome Extension
      # Compile and package the extension for distribution. Assumes 'npm run build' script exists.
      run: npm run build

    - name: Upload coverage reports to Codecov
      uses: codecov/codecov-action@v4
      with:
        token: ${{ secrets.CODECOV_TOKEN }} # Ensure CODECOV_TOKEN is configured in GitHub Secrets
        files: ./coverage/lcov.info # Path to the coverage report generated by Vitest
        fail_ci_if_error: true # Fail the CI if Codecov upload encounters an error

    - name: Run npm audit for security vulnerabilities
      # Scan for known vulnerabilities in dependencies. Fail CI if high severity issues are found.
      run: npm audit --audit-level=high
